<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Create Bill - Admin</title>
  <link rel="icon" type="image/x-icon" href="gym.avif">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #f4f4f4; }
    h2 { text-align: center; }
    label { display: block; margin-top: 10px; }
    input, select, button { width: 100%; padding: 8px; margin-top: 5px; }
    .container { max-width: 500px; margin: auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    .bill-preview { margin-top: 20px; padding: 15px; background: #fff; border: 1px solid #ccc; }
    .btn { background-color: #28a745; color: white; border: none; cursor: pointer; margin-top: 15px; }
    .btn:hover { background-color: #218838; }
  </style>
</head>
<body>
  <div class="container">
    <h2>Create Bill</h2>

    <label for="memberSelect">Select Member</label>
    <select id="memberSelect"></select>

    <label for="package">Package</label>
    <input type="text" id="package" readonly />

    <label for="amount">Amount (₹)</label>
    <input type="number" id="amount" />

    <label for="paymentDate">Payment Date</label>
    <input type="date" id="paymentDate" />

    <label for="method">Payment Method</label>
    <select id="method">
      <option value="Cash">Cash</option>
      <option value="UPI">UPI</option>
      <option value="Card">Card</option>
    </select>

    <button class="btn" onclick="generateBill()">Generate Bill</button>

    <div class="bill-preview" id="billPreview" style="display:none;"></div>
    <button class="btn" onclick="downloadPDF()" id="downloadBtn" style="display:none;">Download PDF</button>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getFirestore, collection, getDocs, doc, setDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
    import { firebaseConfig } from './script/firebase.js';

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const memberSelect = document.getElementById("memberSelect");
    const packageInput = document.getElementById("package");
    const amountInput = document.getElementById("amount");
    let membersData = {};

    // Load members into dropdown
    async function loadMembers() {
      const snapshot = await getDocs(collection(db, "members"));
      snapshot.forEach((docSnap) => {
        const data = docSnap.data();
        membersData[docSnap.id] = data;
        const option = document.createElement("option");
        option.value = docSnap.id;
        option.textContent = `${data.name} (${data.email})`;
        memberSelect.appendChild(option);
      });
    }

    memberSelect.addEventListener("change", () => {
      const memberId = memberSelect.value;
      if (memberId) {
        const data = membersData[memberId];
        packageInput.value = data.package || "";
        amountInput.value = getPackageAmount(data.package);
      }
    });

    function getPackageAmount(pkg) {
      switch (pkg) {
        case "Monthly": return 1000;
        case "Quarterly": return 2500;
        case "Yearly": return 9000;
        default: return 0;
      }
    }

    window.generateBill = async () => {
      const memberId = memberSelect.value;
      if (!memberId) return alert("Please select a member");

      const data = membersData[memberId];
      const amount = amountInput.value;
      const paymentDate = document.getElementById("paymentDate").value;
      const method = document.getElementById("method").value;

      const billHTML = `
        <h3>Velvet Pulse Fitness - Payment Receipt</h3>
        <p><strong>Name:</strong> ${data.name}</p>
        <p><strong>Email:</strong> ${data.email}</p>
        <p><strong>Phone:</strong> ${data.phone}</p>
        <p><strong>Package:</strong> ${data.package}</p>
        <p><strong>Amount Paid:</strong> ₹${amount}</p>
        <p><strong>Date:</strong> ${paymentDate}</p>
        <p><strong>Method:</strong> ${method}</p>
      `;

      document.getElementById("billPreview").innerHTML = billHTML;
      document.getElementById("billPreview").style.display = "block";
      document.getElementById("downloadBtn").style.display = "block";

      // Optional: Store bill in Firestore
      const billRef = doc(collection(db, "bills"));
      await setDoc(billRef, {
        memberId,
        name: data.name,
        email: data.email,
        phone: data.phone,
        package: data.package,
        amount: parseInt(amount),
        paymentDate,
        method,
        createdAt: new Date().toISOString()
      });
    };

    window.downloadPDF = () => {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.html(document.getElementById("billPreview"), {
        callback: function (pdf) {
          pdf.save("Gym_Bill.pdf");
        },
        x: 10,
        y: 10
      });
    };

    loadMembers();
  </script>
</body>
</html>
